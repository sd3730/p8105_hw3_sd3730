---
title: "p8105_hw3_sd3730"
author: "Stacey Dai"
date: "2024-10-13"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggridges)
library(patchwork)

library(p8105.datasets)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1

#### Load the ny_noaa dataset
```{r}
data("ny_noaa")
```

This dataset contains `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. Variables include weather station id, date of observation,  (tenths of mm), snowfall (mm), snow depth (mm), and min and max temperature (tenths of degrees C).

#### Do some data cleaning. Create separate variables for year, month, and day. Ensure observations for temperature, precipitation, and snowfall are given in reasonable units. For snowfall, what are the most commonly observed values? Why?

Below we clean the data, creating separate variables for year, month, and day and converting `tmax` and `tmin` to numeric. We find that 0 is the most commonly observed value for snowfall. This is because most days of the year, it does not snow at all in NY. The second most commonly observed value is `NA`, indicating missingness. Other common values are 13, 25, and 51, suggesting that snowfall is originally recorded in fractions of an inch and converted to mm.

```{r cleandata, message = FALSE}
ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n))

ny_noaa = 
  ny_noaa %>% 
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>% 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))
```

#### Make a two-panel plot showing the average max temperature in January and in July in each station across years. Is there any observable / interpretable structure? Any outliers?

Below is a two-panel plot showing the average max temperature in January and in July in each station across years.

```{r twopanel, message = FALSE}
ny_noaa %>% 
  group_by(id, year, month) %>% 
  filter(month %in% c(1, 7)) %>% 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) %>% 
  ggplot(aes(x = year, y = mean_tmax, group = id)) + geom_point() + geom_path() +
  facet_grid(~month) +
  labs(title = "Mean monthly temperature for each station across years for January and July")
```

The mean temperature in January is much lower than the mean temperature in July for all stations and across all years. All stations appear to follow similar trends of temperature peaks and valleys within a month across the years, i.e. when one station has a high monthly mean temperature for a given year, most other stations also have a high monthly mean temperature for that year. We do see one uncharacteristically cold station in July of 1987 or 1988, as well as a few other less drastic outliers.

#### Make a two-panel plot showing (i) tmax vs tmin for the full dataset (note that a scatterplot may not be the best option); and (ii) make a plot showing the distribution of snowfall values greater than 0 and less than 100 separately by year.

Below we show a two-panel plot including (i) a hex plot of `tmax` vs `tmin` for the full dataset; and (ii) a ridge plot showing the distribution of snowfall values (in mm) greater than 0 and less than 100 separately by year. 

```{r ridgeplot, message = FALSE}
hex = 
  ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

ridge = 
  ny_noaa %>% 
  filter(snow < 100, snow > 0) %>%
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges()

hex + ridge
```

From the hex plot we see that while there is some variability, the majority of the data cluster tightly in the center of the distribution. In relatively rare cases, it seems that `tmax` is less than `tmin`, which raises questions about data recording and quality.

From the ridge plot, we see a multimodal density of snowfall within a given year. Most stations see between 0 and  35 mm of snow in a year. Then there is a another group of stations that see about 45 mm of snow, and another group that sees nearly 80 mm. It is likely this multimodality stems from the conversion of measurements in one system (fractions of an inch) to another (using the metric system), which was also noted in the table of common values. 

# Problem 2

#### Load the dataset
```{r p2_setup, message = FALSE}
library(readr)

demographic_data = read_csv (file = "./data/nhanes_covar.csv", skip = 4)
names(demographic_data) = c("SEQN", "sex", "age", "BMI", "education")

accelerometer_data = read_csv (file = "./data/nhanes_accel.csv")
```

#### Clean and merge the datasets
We will filter out participants under 21 years of age and handle missing values. We will also tidy the data so that it is long-form and each observation represents a minute-by-minute MIMS reading for a participant.

```{r p2_cleanup}
library(tidyr)

demographic_data_clean = demographic_data %>%
  filter(age >= 21) %>%
  drop_na()

accelerometer_data_long = accelerometer_data %>%
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",
    values_to = "value"
  )
```

After cleaning both datasets, merge them on the participant ID to create a single dataset.
```{r p2_merge}
library(dplyr)

merged_data = accelerometer_data_long %>%
  left_join(demographic_data_clean, by = "SEQN") %>%
  mutate(
    sex = factor(sex, levels = c(1,2), labels = c("Male", "Female")),
    education = factor(education, levels = c(1, 2, 3), 
                       labels = c("Less than HS", "HS equivalent", "More than HS"))
  )
```

#### Table of Men and Women by Education Category

```{r p2_table}
library(knitr)

education_sex_table = merged_data %>%
  filter(!is.na(education)) %>%
  distinct(SEQN, .keep_all = TRUE) %>%
  count(education, sex) %>%
  pivot_wider(names_from = sex, values_from = n, values_fill = 0)

kable(education_sex_table, caption = "Number of Men and Women in Each Education Category")
```

The table shows that among participants with less than a high school education, there are slightly more females (28) than males (27). This suggests a relatively balanced distribution between genders in this category. 

* In the HS equivalent category, the male count (35) is higher than the female count (23). This may indicate a trend where more males than females have completed high school, though the gap is not very large.
* The category with the highest counts is the "More than HS" category, where there are 56 males compared to 59 females. This demonstrates that women in this group slightly outnumber men. The data suggests that a significant portion of both genders continues their education beyond high school, with a slight female majority in higher education.

Overall, the data indicates that females are represented slightly more in the less than HS and more than HS categories, while males are slightly more represented in the HS equivalent category. This could point to varying educational trends and social factors affecting education levels by gender within this population.
This distribution can prompt further analysis into factors that influence educational attainment, such as socioeconomic status, cultural expectations, and access to educational resources for each gender.

#### Visualization of Age Distributions by Sex and Education
```{r p2_visual}
library(ggplot2)

cleaned_data = merged_data %>%
  filter(!is.na(age) & !is.na(education))

ggplot(merged_data, aes(x = age, fill = sex)) +
  geom_histogram(position = "dodge", binwidth = 5) +
  facet_wrap(~education) +
  labs(
    title = "Age Distribution by Education Level and Sex",
    x = "Age",
    y = "Count",
    fill = "Sex"
  ) +
  theme_minimal()
```

The histogram displays the age distributions of men and women across different education levels, allowing for a comparative analysis between sexes within each education category. 

* In the 'Less than HS' category, there are slightly more women than men, with ages primarily concentrated in the lower age brackets. Conversely, in the 'More than HS' category, men and women appear to have similar age distributions, but women are slightly more prevalent in the older age groups.The data indicates that younger men tend to have a higher representation in the 'HS equivalent' and 'More than HS' categories compared to women, who show a more balanced distribution across ages in the same education levels.
* The age distribution for both sexes in the 'More than HS' category shows a pronounced peak around the mid-30s, suggesting that this group may be more engaged in higher education or career advancement at that age. 

Overall, this visualization underscores the importance of educational attainment and its relationship with age demographics, providing valuable insights for understanding the socio-economic landscape among different genders.

#### Total Activity by Age and Education, Separated by Sex

Aggregate MIMS values to total activity for each participant
```{r agg_mim, message = FALSE}
total_activity_data <- merged_data %>%
  group_by(SEQN, age, sex, education) %>%
  summarize(total_activity = sum(value, na.rm = TRUE))
```

Plot total activity vs age, separated by sex and education level
```{r activity_plot, message = FALSE}
ggplot(total_activity_data, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess") +
  facet_wrap(~education) +
  labs(
    title = "Total Daily Activity by Age, Sex, and Education Level",
    x = "Age",
    y = "Total Activity (MIMS)"
  ) +
  theme_minimal()
```

The plot illustrates total daily activity (in MIMS) against age for different educational levels, separated by sex. Each panel represents a unique education level category: "Less than HS," "HS equivalent," "More than HS," and "NA." 

* There is a noticeable decline in total daily activity with increasing age across all education levels. This suggests that as participants grow older, their physical activity decreases, which aligns with common findings in physical activity research. In the "Less than HS" and "More than HS" panels, men (represented by the dark purple line) tend to exhibit higher total daily activity levels than women (represented by the yellow line) throughout most age ranges. 
* However, in the "HS equivalent" panel, the gap between male and female activity levels appears narrower, suggesting that educational attainment may influence the disparity in activity levels between sexes. The trend lines for both sexes show a consistent downward trajectory as age increases, indicating that both men and women become less active as they age. 
* Notably, the younger age group (20-30 years) shows higher activity levels, particularly for those with "More than HS" education, while older age groups experience a significant decline. 

Overall, the findings suggest that education level plays a significant role in physical activity levels across age groups, with men generally being more active than women. These insights can inform future health interventions aimed at promoting physical activity, particularly targeting older adults and addressing gender disparities in activity levels.

#### 24-Hour Activity Time Course by Education Level and Sex
Summarize MIMS values over the course of a day by hour
```{r sum_mim, message = FALSE}
activity_time_course = merged_data %>%
  group_by(minute, sex, education) %>%
  summarise(mean_activity = mean(value, na.rm = TRUE)) %>%
  ungroup()
```

This is to convert the minute variable to hours.
```{r min_to_hours}
activity_time_course = activity_time_course %>%
  mutate(hour = as.numeric(gsub("min", "", minute)) / 60)
```

This is a plot that shows the 24-hour activity time courses for each education level and use color to indicate sex. 
```{r 24hr_plot}
ggplot(activity_time_course, aes(x = hour, y = mean_activity, color = sex)) +
  geom_line(linewidth = 1) +
  facet_wrap(~education) +
  labs(
    title = "24-Hour Activity Time Course by Education Level and Sex",
    x = "Time of Day (Hours)",
    y = "Mean Activity (MIMS)",
    color = "Sex"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  scale_x_continuous(breaks = seq(0, 24, by = 2))
```
The title of the graph clearly indicates the graph's purpose, showing the activity levels throughout a 24-hour period segmented by education level and sex. The x-axis represents the Time of Day (Hours), ranging from 0 to 24, while the y-axis indicates the Mean Activity (MIMS).

* Across all education levels, males tend to have higher mean activity levels than females, as indicated by the consistently higher purple line compared to the yellow line. This trend may suggest that males are generally more physically active than females, regardless of their educational background.
* The "Less than HS" group displays a clear daily activity rhythm, with males showing notably higher activity than females during the morning peak. The overall activity levels for this group are lower than those in the "More than HS" category.
* Similar trends are visible here, but the gap between males and females appears narrower than in the "Less than HS" group. This could imply that those with a high school equivalent education may engage in more balanced activity levels across genders.
* The "More than HS" panel shows both sexes maintaining higher activity levels throughout the day compared to the other groups, suggesting that individuals with higher educational attainment might be more active overall. The gap between males and females remains, but it is less pronounced than in the other categories.

Overall, this graph illustrates clear daily rhythms of physical activity that vary by educational attainment and sex. Males consistently demonstrate higher activity levels than females, and those with higher educational levels appear to maintain higher activity throughout the day. 

# Problem 3

#### Import the NYC Citi Bike System data
```{r p3_setup, message = FALSE}
library(lubridate)

jan2020 = read_csv("./citibike/Jan 2020 Citi.csv") %>%
  mutate(month = "January", year = 2020)
jan2024 = read_csv("./citibike/Jan 2024 Citi.csv") %>%
  mutate(month = "January", year = 2024)
july2020 = read_csv("./citibike/July 2020 Citi.csv") %>%
  mutate(month = "July", year = 2020)
july2024 = read_csv("./citibike/July 2024 Citi.csv") %>%
  mutate(month = "July", year = 2024)

citi_bike = bind_rows(jan2020, jan2024, july2020, july2024)
```

#### Clean and tidy dataset
```{r p3_cleanup}
citi_bike_data <- citi_bike %>%
  filter(!is.na(ride_id)) %>%
  mutate(duration = as.numeric(duration))
```

#### Total number of rides by year and month
```{r sum_table, message = FALSE}
rides_summary = citi_bike_data %>%
   group_by(year, month, member_casual) %>%
  summarize(total_rides = n(), .groups = 'drop') %>%
  pivot_wider(names_from = member_casual, values_from = total_rides, values_fill = list(total_rides = 0))

library(knitr)
kable(rides_summary, caption = "Total Rides by Year, Month, and Membership Type")
```

From January 2020 to July 2024, there is a clear upward trend in the total number of rides for both casual users and members. In January 2020, there were 12,420 rides in total (984 casual + 11,436 members), which increased significantly to 47,156 rides in July 2024 (10,894 casual + 36,262 members). This suggests a strong overall growth in the popularity of the Citi Bike system over the four-year period.

* The data shows a consistent pattern where July sees significantly higher ride counts compared to January. This is expected due to warmer weather, which encourages biking for both leisure and commuting purposes.
* Casual rides have increased from 984 in January 2020 to 10,894 in July 2024. This indicates a growth in the number of people using Citi Bike for leisure and recreational activities, possibly spurred by the COVID-19 pandemic as more people turned to biking as a safe alternative to public transport.
* Member rides also show substantial growth, from 11,436 in January 2020 to 36,262 in July 2024. This suggests that more individuals are opting for membership, likely due to the cost-effectiveness and convenience of being a member. The increase in member rides during both winter and summer months indicates that members are using the service consistently throughout the year, not just in peak biking months.
* In January 2020, member rides (11,436) vastly outnumbered casual rides (984), showcasing the Citi Bike system's initial reliance on memberships. By July 2024, although member rides still exceed casual rides, the gap has narrowed significantly, suggesting that casual riders are becoming a larger part of the user base. The growth in casual riders is particularly notable given that the system has traditionally catered more to members, highlighting a shift in biking culture and increased accessibility.

#### Popular starting stations for July 2024
```{r pop_stations}
july_2024_data = citi_bike %>%
  filter(year == 2024 & month == "July")

top_stations = july_2024_data %>%
  group_by(start_station_name) %>%
  summarise(num_rides = n()) %>%
  arrange(desc(num_rides)) %>%
  slice_head(n = 5) 

kable(top_stations, caption = "Top 5 Most Popular Starting Stations in July 2024")
```

#### Effect of day, month, and year on median ride duration
```{r duration}
ride_duration_summary = citi_bike %>%
  group_by(year, month, weekdays) %>%
  summarise(median_duration = median(duration), .groups = "drop")

ggplot(ride_duration_summary, aes(x = weekdays, y = median_duration, color = month)) +
  geom_line(aes(group = interaction(month, year))) +
  facet_wrap(~ year) +
  labs(title = "Median Ride Duration by Day of the Week, Month, and Year",
       x = "Day of the Week", y = "Median Ride Duration (minutes)") +
  theme_minimal()
```
The graph shows clear differences in median ride duration between January and July for both years (2020 and 2024). January (represented by the purple line) tends to have relatively lower median ride durations, typically ranging from about 7.5 to 12.5 minutes across the days of the week. In contrast, July (represented by the yellow line) exhibits higher median ride durations, peaking around 15 minutes on certain days, especially during the weekends.

* The notable increase in median ride duration in July suggests that riders may be utilizing the Citi Bike system more for leisure activities during the warmer months, leading to longer ride times compared to January, which is likely influenced by colder weather and potential commuting patterns.
* For 2024, the trend of longer rides in July compared to January persists, but there appears to be some variation in ride durations compared to 2020.
* The graph highlights different patterns across the days of the week. In January, median ride durations do not vary much throughout the week, suggesting more consistent, perhaps commuter-based usage. In July, the ride durations show a greater fluctuation throughout the week, with weekends generally having higher ride times. This could reflect increased recreational usage on weekends, with more riders taking longer leisure rides.

#### Impact of month, membership status, and bike type on ride duration in 2024
```{r 2024_data}
data_2024 <- citi_bike %>%
  filter(year == 2024)

ggplot(data_2024, aes(x = month, y = duration, fill = member_casual)) +
  geom_boxplot() +
  facet_wrap(~ rideable_type) +
  labs(title = "Ride Duration Distribution by Month, Membership Status, and Bike Type (2024)",
       x = "Month", y = "Ride Duration (minutes)") +
  theme_minimal()
```
The graph compares the ride duration distributions for two types of bikes (classic and electric) across two months (January and July) and separates them by membership status (casual vs. member). The boxplots provide a clear visualization of the median, quartiles, and potential outliers in ride duration for each category.

* January shows lower overall ride durations for both types of bikes compared to July. This is consistent with the expectation that colder weather in January may discourage longer rides, while warmer summer conditions in July encourage more leisure riding. In July, both bike types exhibit significantly longer ride durations, with the potential for casual riders taking advantage of the good weather for extended rides.
* For both months, members (represented by the yellow boxes) consistently show longer median ride durations compared to casual riders (represented by the purple boxes). This indicates that members are likely using the bikes more frequently and for longer periods, possibly for commuting or regular exercise.
* Both months display a significant number of outliers, particularly for longer ride durations. This suggests that some rides, especially in July, may be much longer than the typical use case, possibly due to recreational biking or group rides.
* The graph allows for a comparison between electric and classic bikes. While the overall patterns are similar, any differences in the ride duration distributions could suggest varying user preferences or behaviors based on bike type.